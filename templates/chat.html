{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat {{ request.user.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        #chatWindow {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f9f9f9;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 10px;
        }
        .message .sender {
            font-weight: bold;
        }
        .dept-list a.active {
            font-weight: bold;
            color: #0d6efd;
        }
        .badge.d-none {
            display: none
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">

        <!-- Department Sidebar -->
        <div class="col-md-3">
            <h5 class="mt-3">Departments</h5>
            <!-- In chat.html -->
            <ul class="list-group dept-list" id="deptList">
                {% for dept in departments %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'chat_with_dept' dept.id %}"
                           class="{% if selected_dept and selected_dept.id == dept.id %}active{% endif %}">
                            {{ dept.name }}
                        </a>
                        <span class="badge bg-danger rounded-pill d-none" id="unread_{{ dept.id }}">0</span>
                    </li>
                {% endfor %}
            </ul>
            <br>
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">logout</button>
            </form>

        </div>

<div class="col-md-6">
    <h4 class="mt-3">
        {% if selected_dept %}
            Chat with <strong>{{ selected_dept.name }}</strong>
        {% else %}
            Select a department to start chatting
        {% endif %}
    </h4>

    {% if selected_dept %}
        <div id="chatWindow">
            {% for msg in messages %}
                <div class="message">
                    <div class="sender text-muted small">
                        {{ msg.sender.name }} ({{ msg.sender.userprofile.department.name }}) at {{ msg.timestamp|date:"H:i" }}
                    </div>
                    <div>{{ msg.content | safe }}</div>
                </div>
            {% empty %}
                <div class="text-muted">No messages yet.</div>
            {% endfor %}
        </div>

        <form method="post" id="chatForm">
            {% csrf_token %}

            <input type="hidden" id="toDeptId" name="to_department" value="{{ selected_dept.id }}">

            <div class="mb-2">
                <textarea name="{{ message_form.content.name }}" id="id_{{ message_form.content.name }}"
                          class="form-control"
                          rows="3"
                          placeholder="Type your message…">{{ message_form.content.value|default_if_none:'' }}</textarea>
                {% for error in message_form.content.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="mb-2">
                <label for="fileInput" class="form-label">Attach file:</label>
                <input type="file" id="fileInput" class="form-control">
            </div>

            <button type="submit" class="btn btn-primary mt-2">Send</button>
        </form>
    {% endif %}
</div>


    </div>
</div>
<script>
    const selectedDeptId = "{{ selected_dept.id }}";
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

    chatSocket.onopen = function () {
        if (selectedDeptId) {
            chatSocket.send(JSON.stringify({
                action: "mark_as_read",
                department_id: selectedDeptId
            }));
        }
    };

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        const currentDeptIdInput = document.getElementById("toDeptId");
        const currentDeptId = currentDeptIdInput ? currentDeptIdInput.value : null;

        if (data.type === 'chat_message') {
            if (!currentDeptId || (data.receiver_dept_id != currentDeptId && data.sender_dept_id != currentDeptId)) return;

            const chatWindow = document.getElementById('chatWindow');
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let contentHTML = '';
            if (data.message) {
                contentHTML += `<div>${data.message}</div>`;
            }

            if (data.file_url) {
                contentHTML += `<div><a href="${data.file_url}" target="_blank" class="btn btn-outline-secondary btn-sm mt-1">${data.file_name}</a></div>`;
            }

            msgDiv.innerHTML = `
                <div class="sender text-muted small">
                    ${data.sender} (${data.sender_dept}) → ${data.receiver_dept} at ${timestamp}
                </div>
                ${contentHTML}
            `;

            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            chatSocket.send(JSON.stringify({
                action: "mark_as_read",
                department_id: currentDeptId
            }));
        }

        if (data.type === 'unread_counts') {
            for (const [deptId, count] of Object.entries(data.counts)) {
                if (deptId === currentDeptId) continue;
                const badge = document.getElementById('unread_' + deptId);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.classList.remove('d-none');
                    } else {
                        badge.classList.add('d-none');
                    }
                }
            }
        }
    };

    document.getElementById("chatForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const content = document.querySelector("textarea[name='content']").value;
        const toDept = document.getElementById("toDeptId").value;
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                chatSocket.send(JSON.stringify({
                    action: "upload_file",
                    filename: file.name,
                    file_data: event.target.result,
                    receiver_dept_id: toDept
                }));
            };
            reader.readAsDataURL(file);
        }

        if (content.trim()) {
            chatSocket.send(JSON.stringify({
                receiver_dept_id: toDept,
                message: content
            }));
        }

        document.querySelector("textarea[name='content']").value = '';
        fileInput.value = '';
    });
</script>


</body>
</html>
