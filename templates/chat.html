{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat {{ request.user.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        #chatWindow {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f9f9f9;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 10px;
        }
        .message .sender {
            font-weight: bold;
        }
        .dept-list a.active {
            font-weight: bold;
            color: #0d6efd;
        }
        .badge.d-none {
            display: none
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">

        <!-- Department Sidebar -->
        <div class="col-md-3">
            <h5 class="mt-3">Departments</h5>
            <!-- In chat.html -->
            <ul class="list-group dept-list" id="deptList">
                {% for dept in departments %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'chat_with_dept' dept.id %}"
                           class="{% if selected_dept and selected_dept.id == dept.id %}active{% endif %}">
                            {{ dept.name }}
                        </a>
                        <span class="badge bg-danger rounded-pill d-none" id="unread_{{ dept.id }}">0</span>
                    </li>
                {% endfor %}
            </ul>
            <br>
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">logout</button>
            </form>

        </div>

        <!-- Chat Area -->
        <div class="col-md-6">
            <h4 class="mt-3">
                {% if selected_dept %}
                    Chat with <strong>{{ selected_dept.name }}</strong>
                {% else %}
                    Select a department to start chatting
                {% endif %}
            </h4>

            {% if selected_dept %}
                <div id="chatWindow">
                    {% for msg in messages %}
                        <div class="message">
                            <div class="sender text-muted small">
                                {{ msg.sender.name }} ({{ msg.sender.userprofile.department.name }}) at {{ msg.timestamp|date:"H:i" }}
                            </div>
                            <div>{{ msg.content }}</div>
                        </div>
                    {% empty %}
                        <div class="text-muted">No messages yet.</div>
                    {% endfor %}
                </div>

                <!-- Message Form -->
                <form method="post" id="chatForm">
    {% csrf_token %}

    {# who you’re sending to #}
    <input type="hidden" id="toDeptId" name="to_department"
           value="{{ selected_dept.id }}">

    {# --- “content” textarea rendered by hand --- #}
    <div class="mb-2">
        <textarea name="{{ message_form.content.name }}" id="id_{{ message_form.content.name }}"
                  class="form-control"
                  rows="3"
                  placeholder="Type your message…">{{ message_form.content.value|default_if_none:'' }}</textarea>

        {# show validation errors if any #}
        {% for error in message_form.content.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <button type="submit" class="btn btn-primary mt-2">Send</button>
</form>

            {% endif %}
        </div>

        <!-- File Upload -->
        <div class="col-md-3">
            <h5 class="mt-3">Upload Files</h5>
            <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="mb-3">
        <label for="{{ file_form.file.id_for_label }}" class="form-label">Upload File:</label>
        <input
            type="file"
            name="{{ file_form.file.name }}"
            id="{{ file_form.file.id_for_label }}"
            class="form-control"
        >
        {% for error in file_form.file.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <button type="submit" name="upload_file" class="btn btn-secondary">Upload</button>
</form>


            <h6 class="mt-4">Uploaded Files</h6>
            <ul class="list-group">
                {% for file in files %}
                    <li class="list-group-item">
                        <a href="{{ file.file.url }}">{{ file.file.name }}</a><br>
                        <small class="text-muted">{{ file.uploaded_at|date:"Y-m-d H:i" }}</small>
                    </li>
                {% empty %}
                    <li class="list-group-item">No files uploaded yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<script>
    const selectedDeptId = "{{ selected_dept.id }}";  // Always a string in templates

    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

    chatSocket.onopen = function () {
        if (selectedDeptId) {
            chatSocket.send(JSON.stringify({
                action: "mark_as_read",
                department_id: selectedDeptId
            }));
        }
    };

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === 'chat_message') {
    const currentDeptIdInput = document.getElementById("toDeptId");

    if (!currentDeptIdInput) return;

    const currentDeptId = currentDeptIdInput.value;

    if (data.receiver_dept_id != currentDeptId && data.sender_dept_id != currentDeptId) return;

    const chatWindow = document.getElementById('chatWindow');
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');

    msgDiv.innerHTML = `
        <div class="sender text-muted small">
            ${data.sender} (${data.sender_dept}) → ${data.receiver_dept}
        </div>
        <div>${data.message}</div>
    `;

    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    // ✅ Mark messages as read if this is the currently open chat
    chatSocket.send(JSON.stringify({
        action: "mark_as_read",
        department_id: currentDeptId
    }));
}


        if (data.type === 'unread_counts') {
            const currentDeptIdInput = document.getElementById("toDeptId");
            const currentDeptId = currentDeptIdInput ? currentDeptIdInput.value : null;

            for (const [deptId, count] of Object.entries(data.counts)) {
                // Don’t show unread count for currently selected department
                if (deptId === currentDeptId) continue;

                const badge = document.getElementById('unread_' + deptId);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.classList.remove('d-none');
                    } else {
                        badge.classList.add('d-none');
                    }
                }
            }
        }
    };

    document.getElementById("chatForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const content = document.querySelector("textarea[name='content']").value;
        const toDept = document.getElementById("toDeptId").value;

        if (!content.trim()) return;

        chatSocket.send(JSON.stringify({
            receiver_dept_id: toDept,
            message: content
        }));

        document.querySelector("textarea[name='content']").value = '';
    });
</script>

</body>
</html>
